<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interference - WASM Effect</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }
        
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: block;
            cursor: none;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        /* Side Panel System */
        .side-panel {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            width: 340px;
            height: 100vh;
            display: flex;
            transform: translateX(-320px);
            transition: all 0.3s ease;
        }
        
        .side-panel.active {
            transform: translateX(0);
        }
        
        .panel-content {
            width: 320px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel-tab {
            width: 20px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            backdrop-filter: blur(15px);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            align-self: center;
        }
        
        .panel-tab:hover {
            background: rgba(40, 40, 40, 0.9);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        
        .menu-section {
            margin-bottom: 25px;
        }
        
        .menu-section:last-child {
            margin-bottom: 0;
        }
        
        .menu-section h3 {
            color: #4CAF50;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.3);
            padding-bottom: 8px;
        }
        
        .menu-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .menu-controls.horizontal {
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 16px;
            background: rgba(76, 175, 80, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        button:hover {
            background: rgba(69, 160, 73, 0.9);
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: rgba(102, 102, 102, 0.8);
            cursor: not-allowed;
            transform: none;
        }
        
        .render-mode-btn {
            background: rgba(33, 150, 243, 0.8);
        }
        
        .render-mode-btn:hover {
            background: rgba(30, 136, 229, 0.9);
        }
        
        .render-mode-btn.active {
            background: rgba(76, 175, 80, 0.9);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .aspect-ratio-btn {
            background: rgba(255, 152, 0, 0.8);
        }
        
        .aspect-ratio-btn:hover {
            background: rgba(255, 143, 0, 0.9);
        }
        
        .aspect-ratio-btn.active {
            background: rgba(76, 175, 80, 0.9);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .info-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.4;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .fps-display {
            color: white;
            font-size: 14px;
            font-family: monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .fps-display div {
            margin-bottom: 4px;
        }
        
        .fps-display div:last-child {
            margin-bottom: 0;
        }
        
        /* FPS Overlay */
        .fps-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .fps-overlay.hidden {
            opacity: 0;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .side-panel {
                width: 300px;
                transform: translateX(-280px);
            }
            
            .panel-content {
                width: 280px;
            }
            
            .panel-tab {
                width: 18px;
                height: 100px;
            }
            
            .panel-tab:hover {
                background: rgba(40, 40, 40, 0.9);
                border-color: rgba(255, 255, 255, 0.3);
            }
            
            .menu-section h3 {
                font-size: 14px;
            }
            
            button {
                padding: 12px 16px;
                font-size: 16px;
                min-width: 100px;
            }
            
            .menu-controls.horizontal {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <!-- FPS Overlay -->
    <div class="fps-overlay hidden" id="fpsOverlay">
        Internal FPS: 0
    </div>
    
    <!-- Side Panel -->
    <div class="side-panel active" id="sidePanel">
        <!-- Panel Content -->
        <div class="panel-content">
        <!-- Basic Controls Section -->
        <div class="menu-section">
            <h3>Controls</h3>
            <div class="menu-controls horizontal">
                <button id="startBtn">Start</button>
                <button id="pauseBtn">Pause</button>
                <button id="resetBtn">Reset</button>
            </div>
        </div>
        
        <!-- Render Mode Section - Dynamically populated -->
        <div class="menu-section" id="renderModeSection" style="display: none;">
            <h3>Render Mode</h3>
            <div class="menu-controls" id="renderModeControls">
                <!-- Render mode buttons will be dynamically created here -->
            </div>
        </div>
        
        <!-- Aspect Ratio Section -->
        <div class="menu-section">
            <h3>Aspect Ratio</h3>
            <div class="menu-controls horizontal">
                <button id="aspect4_3Btn" class="aspect-ratio-btn active">4:3</button>
                <button id="aspect16_10Btn" class="aspect-ratio-btn">16:10</button>
                <button id="aspect10_16Btn" class="aspect-ratio-btn">10:16</button>
            </div>
        </div>
        
        <!-- Resolution Section -->
        <div class="menu-section">
            <h3 id="resolutionHeadline">Resolution: 512x320</h3>
            <div class="menu-controls horizontal">
                <button id="halfResolutionBtn" class="aspect-ratio-btn">Half</button>
                <button id="doubleResolutionBtn" class="aspect-ratio-btn">Double</button>
            </div>
        </div>
        
        <!-- Performance Section -->
        <div class="menu-section">
            <h3>Performance</h3>
            <div class="fps-display" id="fpsDisplay">
                <div>Internal FPS: 0</div>
            </div>
            <div class="menu-controls">
                <button id="fpsOverlayBtn">Show FPS Overlay</button>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="menu-section">
            <h3>Info</h3>
            <div class="info-text" id="infoText">
                Loading effect information...
            </div>
        </div>
        </div>
        
        <!-- Panel Tab -->
        <div class="panel-tab" id="panelTab"></div>
    </div>

    <script src="interference.js"></script>
    <script>
        // JavaScript interface for the WASM effect
        let wasmModule = null;
        let isRunning = false;
        let isPaused = false;
        let pixelBuffer = null;
        let imageData = null;
        let fpsCounter = 0;
        let lastTime = 0;
        let currentAspectRatio = 0; // 0 = 4:3, 1 = 16:10, 2 = 10:16
        let menuOpen = true;
        let fpsOverlayVisible = false;
        let renderModeButtons = [];
        
        // WASM Module State Management
        let wasmInitialized = false;
        let wasmInitializationPromise = null;
        
        // Aspect ratio configurations - loaded dynamically from WASM
        let aspectRatios = [];
        
        // Safe WASM function wrapper
        function safeWasmCall(funcName, ...args) {
            if (!wasmInitialized || !Module || !Module[funcName]) {
                console.warn(`WASM function ${funcName} called before module initialization or function not available`);
                return null;
            }
            
            try {
                return Module[funcName](...args);
            } catch (error) {
                console.warn(`Error calling WASM function ${funcName}:`, error);
                return null;
            }
        }
        
        // Safe WASM function wrapper that returns a default value
        function safeWasmCallWithDefault(funcName, defaultValue, ...args) {
            const result = safeWasmCall(funcName, ...args);
            return result !== null ? result : defaultValue;
        }

        // Load aspect ratios from WASM module
        function loadAspectRatios() {
            if (!wasmInitialized) {
                console.warn('WASM module not initialized, using fallback aspect ratios');
                aspectRatios = [
                    { name: '4:3', width: 512, height: 384 },
                    { name: '16:10', width: 512, height: 320 },
                    { name: '10:16', width: 256, height: 410 }
                ];
                return;
            }
            
            try {
                const count = safeWasmCallWithDefault('_getAspectRatioCount', 0);
                if (count === 0) {
                    throw new Error('No aspect ratios available');
                }
                
                aspectRatios = [];
                
                for (let i = 0; i < count; i++) {
                    const namePtr = safeWasmCall('_getAspectRatioName', i);
                    const width = safeWasmCallWithDefault('_getAspectRatioWidth', 512, i);
                    const height = safeWasmCallWithDefault('_getAspectRatioHeight', 320, i);
                    
                    const name = namePtr ? Module.UTF8ToString(namePtr) : `Ratio ${i + 1}`;
                    
                    aspectRatios.push({
                        name: name,
                        width: width,
                        height: height
                    });
                }
                
                console.log('Loaded aspect ratios from WASM:', aspectRatios);
            } catch (error) {
                console.warn('Failed to load aspect ratios from WASM:', error);
                // Set default aspect ratios as fallback
                aspectRatios = [
                    { name: '4:3', width: 512, height: 384 },
                    { name: '16:10', width: 512, height: 320 },
                    { name: '10:16', width: 256, height: 410 }
                ];
                console.log('Using fallback aspect ratios:', aspectRatios);
            }
        }

        // Initialize the demo when the page loads
        window.addEventListener('load', async () => {
            console.log('Page loaded, setting up WASM module...');
            try {
                // Check if module is already initialized
                if (Module && Module._initDemo) {
                    console.log('WASM module already initialized');
                    wasmInitialized = true;
                    setupDemo();
                } else {
                    // Wait for the WASM module to be ready
                    Module.onRuntimeInitialized = function() {
                        console.log('WASM module initialized');
                        wasmInitialized = true;
                        setupDemo();
                    };
                }
                
                function setupDemo() {
                    console.log('Available functions:', Object.keys(Module).filter(key => key.startsWith('_')));
                    
                    // Get the canvas and buttons
                    const canvas = document.getElementById('canvas');
                    const panelTab = document.getElementById('panelTab');
                    const sidePanel = document.getElementById('sidePanel');
                    const startBtn = document.getElementById('startBtn');
                    const pauseBtn = document.getElementById('pauseBtn');
                    const resetBtn = document.getElementById('resetBtn');
                    const aspect4_3Btn = document.getElementById('aspect4_3Btn');
                    const aspect16_10Btn = document.getElementById('aspect16_10Btn');
                    const aspect10_16Btn = document.getElementById('aspect10_16Btn');
                    const fpsOverlayBtn = document.getElementById('fpsOverlayBtn');
                    const halfResolutionBtn = document.getElementById('halfResolutionBtn');
                    const doubleResolutionBtn = document.getElementById('doubleResolutionBtn');
                    
                    // Panel toggle functionality
                    panelTab.addEventListener('click', () => {
                        menuOpen = !menuOpen;
                        sidePanel.classList.toggle('active', menuOpen);
                    });
                    
                    // Close panel when clicking outside
                    document.addEventListener('click', (e) => {
                        if (menuOpen && !sidePanel.contains(e.target)) {
                            menuOpen = false;
                            sidePanel.classList.remove('active');
                        }
                    });
                    
                    // Button event listeners
                    startBtn.addEventListener('click', () => {
                        if (isPaused) {
                            resumeDemo();
                        }
                    });
                    
                    pauseBtn.addEventListener('click', () => {
                        if (isRunning && !isPaused) {
                            pauseDemo();
                        }
                    });
                    
                    resetBtn.addEventListener('click', () => {
                        resetDemo();
                    });
                    
                    // Render mode button event listeners are now handled dynamically
                    
                    // Aspect ratio button event listeners
                    aspect4_3Btn.addEventListener('click', () => {
                        changeAspectRatio(0);
                    });
                    
                    aspect16_10Btn.addEventListener('click', () => {
                        changeAspectRatio(1);
                    });
                    
                    aspect10_16Btn.addEventListener('click', () => {
                        changeAspectRatio(2);
                    });
                    
                    // FPS overlay button event listener
                    fpsOverlayBtn.addEventListener('click', () => {
                        toggleFpsOverlay();
                    });
                    
                    // Resolution button event listeners
                    halfResolutionBtn.addEventListener('click', () => {
                        changeResolution('half');
                    });
                    
                    doubleResolutionBtn.addEventListener('click', () => {
                        changeResolution('double');
                    });
                    
                    // Mouse tracking for the canvas
                    canvas.addEventListener('mousemove', (e) => {
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        // Update mouse position in WASM using safe wrapper
                        safeWasmCall('_updateMousePosition', x, y);
                    });
                    
                    // Keyboard event handling for render modes
                    document.addEventListener('keydown', (e) => {
                        const keyNum = parseInt(e.key);
                        if (!isNaN(keyNum) && keyNum >= 1 && keyNum <= renderModeButtons.length) {
                            const modeIndex = keyNum - 1;
                            if (safeWasmCall('_setRenderMode', modeIndex) !== null) {
                                updateRenderModeDisplay();
                                updateRenderModeButtons(modeIndex);
                            }
                        }
                    });
                    
                    console.log('WASM module loaded successfully');
                    
                    // Function to update aspect ratio button states
                    function updateAspectRatioButtons(activeIndex) {
                        const buttons = [aspect4_3Btn, aspect16_10Btn, aspect10_16Btn];
                        buttons.forEach((btn, index) => {
                            if (btn) {
                                btn.classList.toggle('active', index === activeIndex);
                            }
                        });
                    }
                    
                    // Function to change aspect ratio
                    function changeAspectRatio(index) {
                        currentAspectRatio = index;
                        updateAspectRatioButtons(index);
                        
                        const canvas = document.getElementById('canvas');
                        if (canvas) {
                            // Try to update WASM aspect ratio
                            safeWasmCall('_setAspectRatio', index);
                            
                            // Update canvas size
                            if (aspectRatios.length === 0) {
                                console.warn('Aspect ratios not loaded yet, cannot change aspect ratio');
                                return;
                            }
                            const ratio = aspectRatios[index];
                            canvas.width = ratio.width;
                            canvas.height = ratio.height;
                            
                            // Recreate imageData with new dimensions
                            imageData = new ImageData(ratio.width, ratio.height);
                            console.log('Updated aspect ratio to', ratio.name, ':', ratio.width, 'x', ratio.height);
                            
                            // Update resolution display
                            updateResolutionDisplay();
                            
                            // Update headline with current resolution
                            const resolutionHeadline = document.getElementById('resolutionHeadline');
                            if (resolutionHeadline) {
                                resolutionHeadline.textContent = `Resolution: ${ratio.width}x${ratio.height}`;
                            }
                            
                            // If currently running, restart the rendering loop
                            if (isRunning) {
                                stopRenderingLoop();
                                setTimeout(() => {
                                    startRenderingLoop();
                                }, 50);
                            }
                        }
                    }
                    
                    // Initialize with default aspect ratio (16:10)
                    currentAspectRatio = 1; // 16:10
                    updateAspectRatioButtons(1);
                    
                    // Set up the canvas size first
                    if (canvas) {
                        canvas.width = 512;
                        canvas.height = 320;
                        console.log('Canvas initialized with default size: 512x320');
                    }
                    
                    // Wait a bit for WASM to be fully ready, then set aspect ratio and initialize dynamic UI
                    setTimeout(() => {
                        // Set initial aspect ratio using safe wrapper
                        if (safeWasmCall('_setAspectRatio', 1) !== null) {
                            console.log('Aspect ratio set to 16:10');
                        }
                        
                        // Initialize dynamic UI elements after WASM is fully ready
                        initializeDynamicUI();
                    }, 100);
                    
                    // Handle window resize for fullscreen
                    window.addEventListener('resize', () => {
                        // Auto-detect best aspect ratio based on window size
                        const bestAspectRatio = detectBestAspectRatio();
                        if (bestAspectRatio !== currentAspectRatio) {
                            changeAspectRatio(bestAspectRatio);
                        } else {
                            resizeCanvas();
                        }
                    });
                    
                    // Wait a bit for WASM to be fully ready, then load aspect ratios and start demo
                    setTimeout(() => {
                        loadAspectRatios();
                        
                        // Update canvas size with loaded aspect ratios
                        if (aspectRatios.length > 0) {
                            const canvas = document.getElementById('canvas');
                            const ratio = aspectRatios[currentAspectRatio];
                            if (canvas && ratio) {
                                canvas.width = ratio.width;
                                canvas.height = ratio.height;
                                console.log('Canvas updated with aspect ratio:', ratio.name, ratio.width, 'x', ratio.height);
                            }
                        }
                        
                        // Auto-start the demo after aspect ratios are loaded
                        console.log('Setup complete, auto-starting demo');
                        setTimeout(() => {
                            startDemo();
                        }, 50);
                    }, 100);
                }
                
            } catch (error) {
                console.error('Failed to load WASM module:', error);
                document.body.innerHTML = '<h1>Error loading WASM module</h1><p>Please make sure interference.wasm is built and available.</p>';
            }
            
            // Add a timeout to check if Module.onRuntimeInitialized was called
            setTimeout(() => {
                if (!Module || !Module._initDemo) {
                    console.error('WASM module not loaded after 5 seconds');
                    console.log('Module object:', Module);
                    console.log('Available Module properties:', Object.keys(Module || {}));
                    
                    // Enable start button even if WASM didn't load
                    const startBtn = document.getElementById('startBtn');
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.addEventListener('click', () => {
                            console.log('Start button clicked but WASM not loaded');
                            alert('WASM module failed to load. Please check the console for errors.');
                        });
                    }
                }
            }, 5000);
        });

        // Initialize dynamic UI elements based on WASM module capabilities
        function initializeDynamicUI() {
            if (!wasmInitialized) {
                console.warn('WASM module not initialized for dynamic UI initialization');
                return;
            }
            
            // Get render mode count and create buttons dynamically
            const modeCount = safeWasmCallWithDefault('_getRenderModeCount', 0);
            console.log('Render mode count:', modeCount);
            
            if (modeCount > 0) {
                const renderModeSection = document.getElementById('renderModeSection');
                const renderModeControls = document.getElementById('renderModeControls');
                
                // Show the render mode section
                renderModeSection.style.display = 'block';
                
                // Clear existing buttons
                renderModeControls.innerHTML = '';
                renderModeButtons = [];
                
                // Create buttons for each render mode
                for (let i = 0; i < modeCount; i++) {
                    let modeName = `Mode ${i + 1}`;
                    const modeNamePtr = safeWasmCall('_getRenderModeName', i);
                    if (modeNamePtr) {
                        modeName = Module.UTF8ToString(modeNamePtr);
                    }
                    
                    const button = document.createElement('button');
                    button.id = `renderModeBtn${i}`;
                    button.className = 'render-mode-btn';
                    button.textContent = modeName;
                    button.addEventListener('click', () => {
                        if (safeWasmCall('_setRenderMode', i) !== null) {
                            updateRenderModeDisplay();
                            updateRenderModeButtons(i);
                        }
                    });
                    
                    renderModeControls.appendChild(button);
                    renderModeButtons.push(button);
                }
                
                // Set initial active button
                const currentMode = safeWasmCallWithDefault('_getRenderMode', 0);
                updateRenderModeButtons(currentMode);
            }
            
            // Update info text
            const infoTextPtr = safeWasmCall('_getEffectInfo');
            let infoText = 'Effect information not available';
            if (infoTextPtr) {
                infoText = Module.UTF8ToString(infoTextPtr);
            }
            const infoElement = document.getElementById('infoText');
            if (infoElement) {
                infoElement.innerHTML = infoText;
            }
        }

        function resizeCanvas() {
            const canvas = document.getElementById('canvas');
            if (aspectRatios.length === 0) {
                console.warn('Aspect ratios not loaded yet, skipping canvas resize');
                return;
            }
            const aspectRatio = aspectRatios[currentAspectRatio];
            
            // Set canvas internal dimensions to match aspect ratio
            canvas.width = aspectRatio.width;
            canvas.height = aspectRatio.height;
            
            // Create new ImageData for the current aspect ratio
            const ctx = canvas.getContext('2d');
            imageData = ctx.createImageData(canvas.width, canvas.height);
            
            console.log(`Canvas resized to ${aspectRatio.width}x${aspectRatio.height} (${aspectRatio.name})`);
        }
        
        function detectBestAspectRatio() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const windowAspectRatio = windowWidth / windowHeight;
            
            // Calculate which aspect ratio is closest to the window's aspect ratio
            const aspectRatioValues = [
                4.0 / 3.0,    // 4:3 = 1.33
                16.0 / 10.0,  // 16:10 = 1.6
                10.0 / 16.0   // 10:16 = 0.625
            ];
            
            let bestMatch = 0;
            let smallestDifference = Math.abs(windowAspectRatio - aspectRatioValues[0]);
            
            for (let i = 1; i < aspectRatioValues.length; i++) {
                const difference = Math.abs(windowAspectRatio - aspectRatioValues[i]);
                if (difference < smallestDifference) {
                    smallestDifference = difference;
                    bestMatch = i;
                }
            }
            
            return bestMatch;
        }
        
        function changeAspectRatio(newAspectRatio) {
            if (newAspectRatio >= 0 && newAspectRatio < 3) {
                currentAspectRatio = newAspectRatio;
                
                // Update WASM module using safe wrapper
                safeWasmCall('_changeAspectRatio', newAspectRatio);
                
                // Resize canvas
                resizeCanvas();
                
                // Update button states
                updateAspectRatioButtons(newAspectRatio);
                
                if (aspectRatios.length > newAspectRatio) {
                    console.log(`Aspect ratio changed to ${aspectRatios[newAspectRatio].name}`);
                    // Update headline with current resolution
                    const resolutionHeadline = document.getElementById('resolutionHeadline');
                    if (resolutionHeadline && aspectRatios[newAspectRatio]) {
                        const ratio = aspectRatios[newAspectRatio];
                        resolutionHeadline.textContent = `Resolution: ${ratio.width}x${ratio.height}`;
                    }
                } else {
                    console.log('Aspect ratio changed (aspect ratios not yet loaded)');
                }
            }
        }
        
        function updateAspectRatioButtons(activeAspectRatio) {
            const aspect4_3Btn = document.getElementById('aspect4_3Btn');
            const aspect16_10Btn = document.getElementById('aspect16_10Btn');
            const aspect10_16Btn = document.getElementById('aspect10_16Btn');
            
            if (aspect4_3Btn && aspect16_10Btn && aspect10_16Btn) {
                // Remove active class from all buttons
                aspect4_3Btn.classList.remove('active');
                aspect16_10Btn.classList.remove('active');
                aspect10_16Btn.classList.remove('active');
                
                // Add active class to the current aspect ratio button
                if (activeAspectRatio === 0) {
                    aspect4_3Btn.classList.add('active');
                } else if (activeAspectRatio === 1) {
                    aspect16_10Btn.classList.add('active');
                } else if (activeAspectRatio === 2) {
                    aspect10_16Btn.classList.add('active');
                }
            }
        }

        let renderingLoopId = null;
        
        function startRenderingLoop() {
            // Initialize imageData for the current canvas size
            const canvas = document.getElementById('canvas');
            if (canvas && !imageData) {
                if (aspectRatios.length === 0) {
                    console.warn('Aspect ratios not loaded yet, using default dimensions for imageData');
                    // Use default dimensions if aspect ratios aren't loaded yet
                    imageData = new ImageData(512, 320);
                    console.log('Initialized imageData with default dimensions: 512x320');
                } else {
                    const aspectRatio = aspectRatios[currentAspectRatio];
                    imageData = new ImageData(aspectRatio.width, aspectRatio.height);
                    console.log('Initialized imageData:', aspectRatio.width, 'x', aspectRatio.height);
                }
            }
            
            function renderFrame() {
                if (!isRunning) return;
                
                if (imageData) {
                    // Get the pixel buffer from WASM using safe wrapper
                    const bufferPtr = safeWasmCall('_getPixelBuffer');
                    if (bufferPtr) {
                        // Get current canvas dimensions
                        let width, height;
                        if (aspectRatios.length === 0) {
                            // Use default dimensions if aspect ratios aren't loaded yet
                            width = 512;
                            height = 320;
                        } else {
                            const aspectRatio = aspectRatios[currentAspectRatio];
                            width = aspectRatio.width;
                            height = aspectRatio.height;
                        }
                        const bufferSize = width * height * 4;
                        
                        // Verify imageData matches current dimensions
                        if (imageData.width !== width || imageData.height !== height) {
                            console.log('Recreating imageData for new dimensions');
                            imageData = new ImageData(width, height);
                        }
                        
                        // Create a Uint8Array view of the WASM memory
                        const buffer = new Uint8Array(Module.HEAPU8.buffer, bufferPtr, bufferSize);
                        
                        // Copy pixel data to ImageData
                        imageData.data.set(buffer);
                        
                        // Draw to canvas
                        const ctx = canvas.getContext('2d');
                        ctx.putImageData(imageData, 0, 0);
                        
                        // Update FPS display
                        const fpsDisplay = document.getElementById('fpsDisplay');
                        const cppFps = safeWasmCallWithDefault('_getCppFps', 0);
                        fpsDisplay.innerHTML = `<div>Internal FPS: ${Math.round(cppFps)}</div>`;
                        
                        // Update FPS overlay if visible
                        if (fpsOverlayVisible) {
                            const fpsOverlay = document.getElementById('fpsOverlay');
                            fpsOverlay.innerHTML = `Internal FPS: ${Math.round(cppFps)}`;
                        }
                    }
                }
                
                // Continue the rendering loop
                renderingLoopId = requestAnimationFrame(renderFrame);
            }
            
            // Start the rendering loop
            renderingLoopId = requestAnimationFrame(renderFrame);
        }
        
        function stopRenderingLoop() {
            if (renderingLoopId) {
                cancelAnimationFrame(renderingLoopId);
                renderingLoopId = null;
            }
        }

        function startDemo() {
            console.log('startDemo called, isRunning:', isRunning);
            console.log('Module object:', Module);
            console.log('Module._initDemo:', Module._initDemo);
            
            if (!wasmInitialized) {
                console.error('WASM module not initialized');
                return;
            }
            
            try {
                // Call _initDemo directly (not through safe wrapper) to handle unwind properly
                Module._initDemo();
                // If we get here, the main loop started successfully
                isRunning = true;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                
                console.log('Demo started successfully');
            } catch (error) {
                // "unwind" is expected when starting the main loop
                if (error === 'unwind') {
                    console.log('Main loop started (unwind is expected)');
                    isRunning = true;
                    
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('pauseBtn').disabled = false;
                    
                    // Start the JavaScript rendering loop
                    startRenderingLoop();
                    
                    // Update render mode display
                    updateRenderModeDisplay();
                    
                    // Update button states
                    const currentMode = safeWasmCallWithDefault('_getRenderMode', 0);
                    updateRenderModeButtons(currentMode);
                    
                    // Initialize aspect ratio in WASM now that it's fully ready
                    if (safeWasmCall('_changeAspectRatio', currentAspectRatio) !== null) {
                        console.log(`WASM aspect ratio initialized to ${aspectRatios[currentAspectRatio].name}`);
                    }
                    
                    // Update resolution display
                    updateResolutionDisplay();
                    
                } else {
                    console.error('Error starting demo:', error);
                    isRunning = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                }
            }
        }

        function stopDemo() {
            console.log('stopDemo called, isRunning:', isRunning);
            
            // Stop the rendering loop first
            stopRenderingLoop();
            
            safeWasmCall('_stopDemo');
            
            isRunning = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            
            console.log('Demo stopped');
        }

        function pauseDemo() {
            console.log('pauseDemo called, isPaused:', isPaused);
            
            if (safeWasmCall('_pauseDemo') !== null) {
                isPaused = true;
                
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('startBtn').disabled = false;
                
                console.log('Demo paused');
            }
        }

        function resumeDemo() {
            console.log('resumeDemo called, isPaused:', isPaused);
            
            if (safeWasmCall('_resumeDemo') !== null) {
                isPaused = false;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                
                console.log('Demo resumed');
            }
        }

        function resetDemo() {
            safeWasmCall('_resetDemo');
            console.log('Demo reset');
        }
        
        function updateRenderModeDisplay() {
            if (!wasmInitialized) return;
            
            const mode = safeWasmCallWithDefault('_getRenderMode', 0);
            const modeNamePtr = safeWasmCall('_getRenderModeName', mode);
            let modeName = 'Unknown';
            if (modeNamePtr) {
                modeName = Module.UTF8ToString(modeNamePtr);
            }
            
            const infoElement = document.getElementById('infoText');
            if (infoElement) {
                let baseInfo = 'Effect information not available';
                const infoTextPtr = safeWasmCall('_getEffectInfo');
                if (infoTextPtr) {
                    baseInfo = Module.UTF8ToString(infoTextPtr);
                }
                infoElement.innerHTML = `${baseInfo} (Current: ${modeName})`;
            }
        }
        
        function updateRenderModeButtons(activeMode) {
            renderModeButtons.forEach((btn, index) => {
                if (btn) {
                    btn.classList.toggle('active', index === activeMode);
                }
            });
        }
        
        function toggleFpsOverlay() {
            fpsOverlayVisible = !fpsOverlayVisible;
            const fpsOverlay = document.getElementById('fpsOverlay');
            const fpsOverlayBtn = document.getElementById('fpsOverlayBtn');
            
            if (fpsOverlayVisible) {
                fpsOverlay.classList.remove('hidden');
                fpsOverlayBtn.textContent = 'Hide FPS Overlay';
                fpsOverlayBtn.classList.add('active');
            } else {
                fpsOverlay.classList.add('hidden');
                fpsOverlayBtn.textContent = 'Show FPS Overlay';
                fpsOverlayBtn.classList.remove('active');
            }
        }
        
        function changeResolution(operation) {
            if (!wasmInitialized) {
                console.warn('WASM module not initialized for resolution change');
                return;
            }
            
            if (operation === 'double') {
                safeWasmCall('_doubleResolution');
            } else if (operation === 'half') {
                safeWasmCall('_halfResolution');
            }
            
            // Reload aspect ratios to get updated dimensions
            loadAspectRatios();
            
            // Update canvas size
            const canvas = document.getElementById('canvas');
            if (canvas && aspectRatios.length > 0) {
                const ratio = aspectRatios[currentAspectRatio];
                canvas.width = ratio.width;
                canvas.height = ratio.height;
                
                // Recreate imageData with new dimensions
                imageData = new ImageData(ratio.width, ratio.height);
                console.log('Resolution changed, new canvas size:', ratio.width, 'x', ratio.height);
                
                // Update resolution display
                updateResolutionDisplay();
                
                // If currently running, restart the rendering loop
                if (isRunning) {
                    stopRenderingLoop();
                    setTimeout(() => {
                        startRenderingLoop();
                    }, 50);
                }
            }
        }
        
        function updateResolutionDisplay() {
            if (!wasmInitialized) {
                return;
            }
            
            const width = safeWasmCallWithDefault('_getCurrentResolution', 512);
            const height = safeWasmCallWithDefault('_getCanvasHeight', 320);
            const resolutionHeadline = document.getElementById('resolutionHeadline');
            
            if (resolutionHeadline) {
                resolutionHeadline.textContent = `Resolution: ${width}x${height}`;
            }
        }
    </script>
</body>
</html>
